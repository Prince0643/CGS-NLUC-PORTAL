<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CGS NLUC Portal - Enrollment</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {

            html,
            body {
                margin: 0 !important;
                padding: 0 !important;
            }
        }

        .pdf-container {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: none !important;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gradient-to-b from-green-800 to-emerald-700 text-white flex-shrink-0 flex flex-col">
            <div class="flex flex-col items-center p-5 border-b border-green-600">
                <img src="assets/images/dmmmsu-logo.png" alt="CGS Logo" class="w-28 h-28 mb-2" />
                <div class="text-2xl font-bold">CGS NLUC Portal</div>
            </div>
            <ul class="flex-1 mt-4 space-y-1 px-4">
                <li><a href="home.html" class="block py-2 px-3 rounded hover:bg-green-700 transition">Home</a></li>
                <li><a href="enrollment.html" class="block py-2 px-3 rounded bg-green-700">Enrollment</a></li>
                <li><a href="checklist.html" class="block py-2 px-3 rounded hover:bg-green-700 transition">Checklist</a>
                </li>
                <li><a href="citizens-charter.html"
                        class="block py-2 px-3 rounded hover:bg-green-700 transition">Downloads</a></li>
                <li><a href="chatbot.html" class="block py-2 px-3 rounded hover:bg-green-700 transition">Chatbot</a>
                </li>
                <li><a href="settings.html" class="block py-2 px-3 rounded hover:bg-green-700 transition">Settings</a>
                </li>
            </ul>
            <div class="p-4 border-t border-green-600 text-sm">
                Logged in as: <span id="loggedInUser" class="font-semibold">Loading...</span>
            </div>
        </aside>

        <!-- React root -->
        <main class="flex-1 p-6">
            <div id="root"></div>
        </main>
    </div>

    <script type="text/babel">
        const { useEffect, useMemo, useRef, useState } = React;

        // ---- utils ----
        const api = (path, opts = {}) => fetch(`http://localhost:5000${path}`, opts).then(r => r.json());
        const fmt = n => (Number(n) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // ---- Full form & confirmation component ----
        function FullEnrollmentForm({ pendingSnapshot }) {
            const pdfRef = useRef(null);
            const user = useMemo(() => JSON.parse(localStorage.getItem('user') || '{}'), []);
            const [message, setMessage] = useState('');
            const [programs, setPrograms] = useState([]);
            const [courses, setCourses] = useState([]);
            const [selected, setSelected] = useState([]);
            const [submittedData, setSubmittedData] = useState(null);
            const [fees, setFees] = useState(null);

            const [formData, setFormData] = useState(() => {
                // hydrate from pendingSnapshot if present (status === "pending")
                if (pendingSnapshot?.student) {
                    const s = pendingSnapshot.student;
                    return {
                        name: s.student_name || '',
                        address: s.address || '',
                        email: s.student_email || '',
                        id_number: s.student_id_number || '',
                        program_id: s.program_id || '',
                        program_level: s.program_level || '', // will be filled after program-details
                        academic_year: s.academic_year || '2025-2026',
                        term: s.term || '1st Sem',
                        student_category: s.student_category || 'New'
                    };
                }
                // fresh defaults
                return {
                    name: '',
                    address: '',
                    email: '',
                    id_number: '',
                    program_id: '',
                    program_level: '',
                    academic_year: '2025-2026',
                    term: '1st Sem',
                    student_category: 'New'
                };
            });

            // load programs
            useEffect(() => { api('/api/programs').then(setPrograms).catch(() => { }); }, []);

            // if we have a pending snapshot, fetch offered for that program and mark selected courses
            useEffect(() => {
                const initFromPending = async () => {
                    if (!pendingSnapshot?.student?.program_id) return;
                    try {
                        // program details to fill level
                        const pd = await api(`/api/program-details/${pendingSnapshot.student.program_id}`);
                        const p = Array.isArray(pd) ? pd[0] : pd;
                        setFormData(prev => ({ ...prev, program_level: p?.program_level || prev.program_level }));

                        // offered courses for this program
                        const offered = await api(`/api/courses/offered/${pendingSnapshot.student.program_id}`);
                        setCourses(offered || []);

                        // which ones did the student select?
                        const selectedIds = (pendingSnapshot.courses || []).map(c => c.course_id).filter(Boolean);
                        setSelected(selectedIds);

                        // also prepare confirmation view data right away
                        setSubmittedData({
                            selectedCourses: selectedIds.map(id => offered.find(c => c.course_id === id)).filter(Boolean)
                        });

                        // fetch their computed fees snapshot (if exists)
                        const f = await api(`/api/enrollment-fees/${user.id}`).catch(() => null);
                        if (!f?.error) setFees(f);

                    } catch (e) { console.error(e); }
                };
                initFromPending();
                // eslint-disable-next-line
            }, [pendingSnapshot, user?.id]);

            // when user selects a program manually (fresh enrollment)
            const handleProgramSelect = async (e) => {
                const program_id = e.target.value;
                setFormData(prev => ({ ...prev, program_id }));
                setSelected([]);
                if (!program_id) { setCourses([]); return; }
                try {
                    const [offered, details] = await Promise.all([
                        api(`/api/courses/offered/${program_id}`),
                        api(`/api/program-details/${program_id}`)
                    ]);
                    setCourses(offered || []);
                    const p = Array.isArray(details) ? details[0] : details;
                    setFormData(prev => ({ ...prev, program_level: p?.program_level || '' }));
                } catch (e) { console.error(e); }
            };

            const handleInput = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const toggleCourse = (id) => {
                setSelected(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setMessage('');
                const required = ['name', 'email', 'id_number', 'academic_year', 'term', 'student_category', 'program_id'];
                for (const k of required) if (!formData[k]) return setMessage('Please complete all required fields.');
                if (selected.length === 0) return setMessage('Select at least one course.');

                try {
                    const res = await api('/api/student-courses/enroll', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            student_id: user.id,
                            student_name: formData.name,
                            student_email: formData.email,
                            student_id_number: formData.id_number,
                            program_id: formData.program_id,
                            course_ids: selected,
                            term: formData.term,
                            student_category: formData.student_category,
                            academic_year: formData.academic_year,
                            address: formData.address
                        })
                    });

                    if (res?.error) {
                        setMessage(res.error);
                        return;
                    }

                    // build confirmation snapshot
                    const selectedCourses = selected.map(id => courses.find(c => c.course_id === id)).filter(Boolean);
                    setSubmittedData({ selectedCourses });

                    const f = await api(`/api/enrollment-fees/${user.id}`).catch(() => null);
                    if (!f?.error) setFees(f);
                    setMessage(res.message || 'Enrollment submitted.');
                } catch (e) {
                    console.error(e);
                    setMessage('Submission failed.');
                }
            };

            const handleDelete = async () => {
                if (!confirm('Delete your enrollment and fees?')) return;
                try {
                    const res = await api(`/api/student-courses/delete/${user.id}`, { method: 'DELETE' });
                    setMessage(res?.message || 'Deleted.');
                    // reset
                    setSubmittedData(null);
                    setFees(null);
                    setSelected([]);
                } catch (e) {
                    console.error(e);
                    setMessage('Failed to delete.');
                }
            };

            const handlePrintPDF = () => {
                if (!pdfRef.current) return;
                html2pdf().set({
                    margin: [10, 10, 10, 10],
                    filename: `Enrollment-${formData.id_number || 'student'}.pdf`,
                    image: { type: 'jpeg', quality: 1 },
                    html2canvas: { scale: 1.5, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'Legal', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all'] }
                }).from(pdfRef.current).save();
            };

            // ---- render ----
            if (submittedData) {
                return (
                    <div className="bg-white p-6 shadow rounded text-sm max-w-3xl mx-auto">
                        <div ref={pdfRef} className="pdf-container bg-white text-black text-sm mx-auto">
                            <h2 className="text-lg font-bold text-center uppercase mb-2">Registration Confirmation</h2>

                            <div className="grid grid-cols-3 gap-4 border-b pb-2 mb-2">
                                <div><strong>STUDENT CATEGORY:</strong> {formData.student_category}</div>
                                <div><strong>SCHOOL YEAR:</strong> {formData.academic_year}</div>
                                <div><strong>TERM:</strong> {formData.term}</div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-2">
                                <div><strong>NAME:</strong> {formData.name}</div>
                                <div><strong>PROGRAM:</strong> {programs.find(p => p.program_id == formData.program_id)?.program_name || 'N/A'}</div>
                                <div><strong>ADDRESS:</strong> {formData.address}</div>
                                <div><strong>ID NUMBER:</strong> {formData.id_number}</div>
                                <div><strong>EMAIL:</strong> {formData.email}</div>
                            </div>

                            <div className="mb-4">
                                <h3 className="font-bold text-center underline mb-1">COURSES</h3>
                                <table className="w-full border border-gray-300 text-sm">
                                    <thead>
                                        <tr className="bg-gray-200">
                                            <th className="p-2 border">COURSE NUMBER</th>
                                            <th className="p-2 border">DESCRIPTIVE TITLE</th>
                                            <th className="p-2 border">UNITS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {submittedData.selectedCourses.map((c, i) => (
                                            <tr key={i}>
                                                <td className="p-2 border">{c.course_code}</td>
                                                <td className="p-2 border">{c.course_description}</td>
                                                <td className="p-2 border text-center">{c.units}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            {fees && (
                                <div className="mb-4">
                                    <h3 className="font-bold text-center underline mb-2">CASHIER ASSESSMENT</h3>
                                    <table className="w-full border text-sm">
                                        <tbody>
                                            {Object.entries({
                                                Entrance: formData.student_category === 'New' ? 100 : 0,
                                                ILS: 150,
                                                Energy: 500,
                                                Registration: 150,
                                                Tuition: fees.tuition_fee,
                                                Athletic: 150,
                                                Cultural: 100,
                                                Library: 200,
                                                "School ID": formData.student_category === 'New' ? 100 : 0,
                                                Internet: 200,
                                                Laboratory: 200,
                                                Development: 1275,
                                                "Medical/Dental": 150,
                                                Guidance: 100
                                            }).map(([label, amount], i) => (
                                                <tr key={i}>
                                                    <td className="p-2 border">{label}</td>
                                                    <td className="p-2 border text-right">{fmt(amount)}</td>
                                                </tr>
                                            ))}
                                            <tr className="font-bold bg-gray-100">
                                                <td className="p-2 border">TOTAL</td>
                                                <td className="p-2 border text-right text-green-700">{fmt(fees.total_fee)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            <p className="text-xs text-gray-600 italic mt-2 text-center">
                                NOTE: This is only the expected fee of your enrollment. For the exact amount, you may ask the cashier.
                            </p>
                        </div>

                        <div className="flex gap-2 mt-4">
                            <button onClick={handlePrintPDF} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Download PDF</button>
                            <button onClick={handleDelete} className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
                        </div>

                        {message && <p className="text-sm mt-3 text-blue-600">{message}</p>}
                    </div>
                );
            }

            return (
                <div className="bg-white p-6 shadow rounded text-sm max-w-3xl mx-auto">
                    <h1 className="text-xl font-bold text-center uppercase mb-4">Enrollment Form</h1>

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block mb-1">Full Name</label>
                            <input name="name" value={formData.name} onChange={handleInput} className="border p-2 rounded w-full" required />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block mb-1">Address</label>
                                <input name="address" value={formData.address} onChange={handleInput} className="border p-2 rounded w-full" />
                            </div>
                            <div>
                                <label className="block mb-1">Email</label>
                                <input type="email" name="email" value={formData.email} onChange={handleInput} className="border p-2 rounded w-full" required />
                            </div>
                            <div>
                                <label className="block mb-1">ID Number</label>
                                <input name="id_number" value={formData.id_number} onChange={handleInput} className="border p-2 rounded w-full" required />
                            </div>
                            <div>
                                <label className="block mb-1">Program</label>
                                <select name="program_id" value={formData.program_id} onChange={handleProgramSelect} className="border p-2 rounded w-full" required>
                                    <option value="">Select Program</option>
                                    {programs.map(p => (
                                        <option key={p.program_id} value={p.program_id}>{p.program_name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block mb-1">Academic Year</label>
                                <input name="academic_year" value={formData.academic_year} onChange={handleInput} className="border p-2 rounded w-full" required />
                            </div>
                            <div>
                                <label className="block mb-1">Term</label>
                                <select name="term" value={formData.term} onChange={handleInput} className="border p-2 rounded w-full" required>
                                    <option value="1st Sem">1st Sem</option>
                                    <option value="2nd Sem">2nd Sem</option>
                                    <option value="Midyear">Midyear</option>
                                </select>
                            </div>
                            <div>
                                <label className="block mb-1">Student Category</label>
                                <select name="student_category" value={formData.student_category} onChange={handleInput} className="border p-2 rounded w-full" required>
                                    <option value="New">New</option>
                                    <option value="Old">Old</option>
                                    <option value="Trans">Transferee</option>
                                </select>
                            </div>
                        </div>

                        <div className="mt-4">
                            <h2 className="font-semibold mb-2">Select Courses</h2>
                            {courses.length === 0 && (
                                <div className="text-gray-500 text-sm">No offered courses for this program.</div>
                            )}
                            {courses.map(c => (
                                <label key={c.course_id} className="flex items-start p-2 border rounded mb-2 hover:bg-gray-50 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        className="mt-1 mr-3"
                                        checked={selected.includes(c.course_id)}
                                        onChange={() => toggleCourse(c.course_id)}
                                    />
                                    <div>
                                        <div className="font-medium">{c.course_code}</div>
                                        <div className="text-gray-600 text-sm">{c.course_description}</div>
                                    </div>
                                </label>
                            ))}
                        </div>

                        <button type="submit" className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 mt-2">Submit Form</button>
                        {message && <p className="text-sm mt-2 text-blue-600">{message}</p>}
                    </form>
                </div>
            );
        }

        // ---- Wrapper decides what to show based on status ----
        function EnrollmentPage() {
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('form'); // 'form' | 'pending' | 'enrolled'
            const [pendingSnapshot, setPendingSnapshot] = useState(null);

            useEffect(() => {
                const start = async () => {
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    if (!user?.id) { setLoading(false); return; }

                    try {
                        const latest = await api(`/api/student/enrollment/latest/${user.id}`);
                        const status = (latest?.status || '').toLowerCase();

                        if (status === 'pending') {
                            setView('pending');
                            setPendingSnapshot({
                                student: latest.student,       // has name/email/id_number/address/program_id/term/AY/category
                                courses: latest.courses || []  // [{course_id, course_code, course_description, units}]
                            });
                        } else if (status === 'enrolled') {
                            setView('enrolled');
                        } else {
                            setView('form');
                        }
                    } catch (e) {
                        console.error('status check failed', e);
                        setView('form');
                    } finally {
                        setLoading(false);
                    }
                };
                start();
            }, []);

            if (loading) {
                return <div className="text-center text-gray-500 mt-20">Checking enrollment status...</div>;
            }

            if (view === 'enrolled') {
                return (
                    <div className="flex items-center justify-center h-full w-full">
                        <div className="bg-white shadow-lg p-10 rounded-lg text-center max-w-md">
                            <h2 className="text-2xl font-bold text-green-600 mb-4">You're Officially Enrolled!</h2>
                            <p className="mb-6 text-gray-600">Welcome! You can now view your academic checklist.</p>
                            <a href="checklist.html" className="inline-block bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 transition">Go to Checklist</a>
                        </div>
                    </div>
                );
            }

            // For pending, we still show the confirmation (PDF/Delete) using the same component
            return <FullEnrollmentForm pendingSnapshot={view === 'pending' ? pendingSnapshot : null} />;
        }

        // ---- mount ----
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnrollmentPage />);
    </script>

    <!-- User info -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const u = JSON.parse(localStorage.getItem('user') || '{}');
            if (u?.email) document.getElementById('loggedInUser').textContent = u.email;
        });
    </script>
</body>

</html>