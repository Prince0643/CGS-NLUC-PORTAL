<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enrollment | CGS Portal</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-indigo-700 text-white flex-shrink-0 flex flex-col">
            <div class="p-5 text-2xl font-bold border-b border-indigo-500">CGS Portal</div>
            <ul class="flex-1 mt-4 space-y-1 px-4">
                <li><a href="home.html" class="block py-2 px-3 rounded hover:bg-indigo-600 transition">Home</a></li>
                <li><a href="enrollment.html" class="block py-2 px-3 rounded bg-indigo-600">Enrollment</a></li>
                <li><a href="checklist.html"
                        class="block py-2 px-3 rounded hover:bg-indigo-600 transition">Checklist</a></li>
                <li><a href="citizens-charter.html"
                        class="block py-2 px-3 rounded hover:bg-indigo-600 transition">Citizens Charter</a></li>
                <li><a href="chatbot.html" class="block py-2 px-3 rounded hover:bg-indigo-600 transition">Chatbot</a>
                </li>
                <li><a href="settings.html" class="block py-2 px-3 rounded hover:bg-indigo-600 transition">Settings</a>
                </li>
            </ul>
            <div class="p-4 border-t border-indigo-600 text-sm">
                Logged in as: <span id="loggedInUser" class="font-semibold">Loading...</span>
            </div>
        </aside>

        <!-- React root -->
        <main class="flex-1 p-6">
            <div id="root"></div>
        </main>
    </div>

    <!-- React + Babel Script -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        function EnrollmentForm() {
            const pdfRef = React.useRef();

            const handlePrintPDF = () => {
                if (!pdfRef.current) return;
                html2pdf().from(pdfRef.current).set({
                    margin: 0.5,
                    filename: `Enrollment-${formData.id_number}.pdf`,
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                }).save();
            };

            const [formData, setFormData] = useState({
                name: '',
                address: '',
                email: '',
                id_number: '',
                program_id: '',
                academic_year: '2025-2026',
                term: '1st Sem',
                student_category: 'New'
            });

            const [programs, setPrograms] = useState([]);
            const [courses, setCourses] = useState([]);
            const [selected, setSelected] = useState([]);
            const [message, setMessage] = useState('');
            const [submittedData, setSubmittedData] = useState(null);
            const [editMode, setEditMode] = useState(false);

            useEffect(() => {
                fetch('http://localhost:5000/api/programs')
                    .then(res => res.json())
                    .then(data => setPrograms(data));
            }, []);

            useEffect(() => {
                const loggedUser = JSON.parse(localStorage.getItem('user'));
                if (!loggedUser) return;

                fetch(`http://localhost:5000/api/enrollment/${loggedUser.id}`)
                    .then(res => res.json())
                    .then(async data => {
                        if (data.enrolled && data.data.length > 0) {
                            const enrollment = data.data[0];

                            const courseRes = await fetch(`http://localhost:5000/api/courses/offered/${enrollment.program_id}`);
                            const courseData = await courseRes.json();
                            setCourses(courseData);

                            const selectedIds = data.data.map(e => e.course_id);
                            const selectedCourses = selectedIds
                                .map(id => courseData.find(c => c.course_id === id))
                                .filter(Boolean);

                            const updatedForm = {
                                name: enrollment.student_name || '',
                                address: enrollment.address || '',
                                email: enrollment.student_email || '',
                                id_number: enrollment.student_id_number || '',
                                program_id: enrollment.program_id || '',
                                academic_year: enrollment.academic_year || '',
                                term: enrollment.term || '',
                                student_category: enrollment.student_category || ''
                            };

                            setFormData(updatedForm);
                            setSelected(selectedIds);
                            setSubmittedData({ formData: updatedForm, selectedIds, selectedCourses });
                        }
                    })
                    .catch(err => console.error('Enrollment fetch error:', err));
            }, []);

            const handleInput = e => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleProgramSelect = async (e) => {
                const program_id = e.target.value;
                setFormData(prev => ({ ...prev, program_id }));
                if (!program_id) return setCourses([]);

                try {
                    const res = await fetch(`http://localhost:5000/api/courses/offered/${program_id}`);
                    const data = await res.json();
                    setCourses(data);
                } catch (err) {
                    console.error('Error loading courses:', err);
                }
            };

            const handleToggle = courseId => {
                setSelected(prev =>
                    prev.includes(courseId) ? prev.filter(id => id !== courseId) : [...prev, courseId]
                );
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const { name, email, id_number, academic_year, term, student_category } = formData;
                if (!name || !email || !id_number || !academic_year || !term || !student_category || selected.length === 0) {
                    setMessage('Please fill out all fields and select at least one course.');
                    return;
                }

                if (submittedData) {
                    setMessage("You have already enrolled.");
                    return;
                }

                const student_id = JSON.parse(localStorage.getItem('user')).id;

                const endpoint = editMode
                    ? `http://localhost:5000/api/student-courses/update/${student_id}`
                    : 'http://localhost:5000/api/student-courses/enroll';

                const method = editMode ? 'PUT' : 'POST';

                try {
                    const res = await fetch(endpoint, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            student_id,
                            student_name: formData.name,
                            student_email: formData.email,
                            student_id_number: formData.id_number,
                            program_id: formData.program_id,
                            course_ids: selected,
                            term: formData.term,
                            student_category: formData.student_category,
                            academic_year: formData.academic_year,
                            address: formData.address
                        })
                    });

                    const result = await res.json();
                    setMessage(result.message || result.error || 'Submitted.');

                    const selectedCourses = selected.map(id => courses.find(c => c.course_id === id)).filter(Boolean);
                    const savedData = { formData, selectedIds: selected, selectedCourses };
                    setSubmittedData(savedData);
                    setEditMode(false);
                } catch (err) {
                    console.error(err);
                    setMessage('Submission failed.');
                }
            };

            const handleDelete = async () => {
                const loggedUser = JSON.parse(localStorage.getItem('user'));
                if (!loggedUser?.id) return alert('User not found.');

                const confirmDelete = confirm("Are you sure you want to delete your enrollment?");
                if (!confirmDelete) return;

                try {
                    const res = await fetch(`http://localhost:5000/api/student-courses/delete/${loggedUser.id}`, {
                        method: 'DELETE'
                    });

                    const result = await res.json();
                    setMessage(result.message || 'Deleted.');
                    window.location.reload(); // force full reset (optional but guarantees clean state)

                    setFormData({
                        name: '',
                        address: '',
                        email: '',
                        id_number: '',
                        program_id: '',
                        academic_year: '2025-2026',
                        term: '1st Sem',
                        student_category: 'New'
                    });
                    setSelected([]);
                    setCourses([]);
                    setSubmittedData(null);
                    setEditMode(false);  // just in case
                } catch (err) {
                    console.error(err);
                    setMessage('Failed to delete.');
                }
            };


            return (
                <div className="bg-white p-6 shadow rounded text-sm max-w-3xl mx-auto">
                    <h1 className="text-xl font-bold text-center uppercase mb-4">Enrollment Form</h1>

                    {!submittedData || editMode ? (
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block mb-1">Full Name</label>
                                    <input type="text" name="name" value={formData.name} onChange={handleInput} className="border p-2 rounded w-full" required />
                                </div>
                                <div>
                                    <label className="block mb-1">Address</label>
                                    <input type="text" name="address" value={formData.address} onChange={handleInput} className="border p-2 rounded w-full" />
                                </div>
                                <div>
                                    <label className="block mb-1">Email</label>
                                    <input type="email" name="email" value={formData.email} onChange={handleInput} className="border p-2 rounded w-full" required />
                                </div>
                                <div>
                                    <label className="block mb-1">ID Number</label>
                                    <input type="text" name="id_number" value={formData.id_number} onChange={handleInput} className="border p-2 rounded w-full" required />
                                </div>
                                <div>
                                    <label className="block mb-1">Program</label>
                                    <select name="program_id" value={formData.program_id || ''} onChange={handleProgramSelect} className="border p-2 rounded w-full" required>
                                        <option value="">Select Program</option>
                                        {programs.map(p => (
                                            <option key={p.program_id} value={p.program_id}>{p.program_name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block mb-1">Academic Year</label>
                                    <input type="text" name="academic_year" value={formData.academic_year || ''} onChange={handleInput} className="border p-2 rounded w-full" required />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block mb-1">Term</label>
                                    <select name="term" value={formData.term || ''} onChange={handleInput} className="border p-2 rounded w-full" required>
                                        <option value="1st Sem">1st Sem</option>
                                        <option value="2nd Sem">2nd Sem</option>
                                        <option value="Midyear">Midyear</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block mb-1">Student Category</label>
                                    <select name="student_category" value={formData.student_category || ''} onChange={handleInput} className="border p-2 rounded w-full" required>
                                        <option value="New">New</option>
                                        <option value="Old">Old</option>
                                        <option value="Trans">Transferee</option>
                                    </select>
                                </div>
                            </div>

                            <div className="mt-4">
                                <h2 className="font-semibold mb-2">Select Courses</h2>
                                {courses.map(course => (
                                    <div key={course.course_id} className="flex items-start p-2 border rounded mb-2 hover:bg-gray-50">
                                        <input
                                            type="checkbox"
                                            id={`course-${course.course_id}`}
                                            checked={selected.includes(course.course_id)}
                                            onChange={() => handleToggle(course.course_id)}
                                            className="mt-1 mr-3"
                                        />
                                        <label htmlFor={`course-${course.course_id}`} className="cursor-pointer">
                                            <div className="font-medium">{course.course_code}</div>
                                            <div className="text-gray-600 text-sm">{course.course_description}</div>
                                        </label>
                                    </div>

                                ))}
                            </div>

                            <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 mt-4">Submit Form</button>
                            {message && <p className="text-sm mt-2 text-blue-600">{message}</p>}
                        </form>
                    ) : (
                        <div>
                            <div ref={pdfRef} className="border p-4 bg-gray-50 rounded mb-4">
                                <h2 className="text-lg font-semibold mb-2">Enrollment Confirmation</h2>
                                <p><strong>Name:</strong> {submittedData.formData.name}</p>
                                <p><strong>Email:</strong> {submittedData.formData.email}</p>
                                <p><strong>Address:</strong> {submittedData.formData.address}</p>
                                <p><strong>ID Number:</strong> {submittedData.formData.id_number}</p>
                                <p><strong>Academic Year:</strong> {submittedData.formData.academic_year}</p>
                                <p><strong>Term:</strong> {submittedData.formData.term}</p>
                                <p><strong>Student Category:</strong> {submittedData.formData.student_category}</p>
                                <p><strong>Courses Selected:</strong></p>
                                <ul className="list-disc list-inside">
                                    {submittedData.selectedCourses.map((course, i) => (
                                        <li key={i}>{course.course_code} - {course.course_description}</li>
                                    ))}
                                </ul>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handlePrintPDF} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    Download PDF
                                </button>
                                <button onClick={handleDelete} className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                    Delete
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnrollmentForm />);
    </script>

    <!-- User Info Script -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const loggedUser = JSON.parse(localStorage.getItem('user'));
            if (loggedUser && loggedUser.email) {
                document.getElementById("loggedInUser").textContent = loggedUser.email;
            }
        });
    </script>
</body>

</html>